# 組態

使用組態有兩個主要步驟

1. 設定組態提供者

內建的提供者有
json ini xml 檔案，或是 使用者秘密(user secrets) 、環境變數、命令列參數等
如果有需要，可以自行加入組態提供者

2. 透過 iconfigration 或是 ioption<T> 取得組態設定

可以在 控制器  view 或是任何 class 注入，並且取得設定


# 組態設定皆由設定提供者( configuration providers )負責

1. 從 `文字檔案` 取得組態設定  json  ini xml
- 常見的有 appsettings.json 、appsettings.{環境}.json
2. 從 `命令列參數` 
3. 從 `環境變數`
4. 從 `記憶體中的 .net 物件`
5. 從未加密的 `secret manager 儲存區` (就是 user secret)
6. 從 `有加密的使用者儲存區` 
7. 自訂組態提供者


組態設定最終都會變成 key-value pairs 的形式
- 所有Key 與 Value 一定是「字串」型態
- 組態設定很容易可被反序列化為任何 POCO 物件
- 組態設定可使用 IConfiguration 取得設定值

## 組態提供者的先後順序

1. appsettings.json
2. appsettings.{環境}.json
3. 環境變數
4. 命令列參數
5. 其他來源

如果多個組態提供者有重複的 key 值，越後面優先權會越高


# 先準備好

# 為什麼連接字串要加密？ 真的需要加密嗎？
早期 asp.net 只有 web.config 可以寫東西
沒有其他地方可以寫連接字串
以前的人寫 code 沒有安全意是
下在檔案的 controller action ，前端參數又不審核
../../ 都吃，就可以拿到 web.config ，大家就想說要加密，又剛好微軟有 web.config 加密功能


----

asp.net 啟動的時候會有一個 log 是從 Hosting.Lifetime 寫出來的，開發時的環境名稱叫做 Development
```sh
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
```


# 土炮的用法

DI 的地方加入 Iconfiguration


> builder.Configuration 不用特別註冊，他本身已經是 singleton

```csharp

private readonly IConfiguration _config;

public MyController(
      IConfiguration config)
{
      _config = config;
}

[HttpGet("GetSomeKey")]
public string GetSomekey()
{
      return _config.GetValue<string>("Somekey")!;
}
```

# 強行別綁定作法
先定義一個 class 對應 資料
```c#
public class AppsSettingsOptions
{
      // 這裡定義一個常數，等等的設定寫起來會比較漂亮
    public const string Appsettings = "Appsettings";

    public string Somekey { get; set; }

    public string SmtpIp { get; set; }

    public int Smtpport { get; set; }
}
```
```c#
builder.Services.Configure<AppsSettingsOptions>
     (builder.Configuration.GetSection(AppsSettingsOptions.Appsettings));
```

最後再用 option 注入




# bind

var appsettings = new AppSettings();
bulider.Configuration.Bind(appsetiings);

如果物件已經有預設值，透過這個綁法可以把